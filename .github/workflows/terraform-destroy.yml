name: Terraform - Destroy Infrastructure (manual)

on:
  workflow_dispatch: {}

permissions:
  contents: read

env:
  AWS_REGION: eu-central-1
  TF_VERSION: 1.9.0

jobs:
  destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Destroy (auto-approve)
        run: |
          set -e
          echo "🗑️ Running terraform destroy -auto-approve"
          terraform destroy -auto-approve || true

      - name: Fallback - delete security group by name
        shell: bash
        run: |
          set -e
          SG_NAME="marinelangrez-forum-security-group"
          echo "Looking for security group named: $SG_NAME"
          # Try to find SG in the account
          SG_ID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=$SG_NAME" --query 'SecurityGroups[0].GroupId' --output text || echo "")
          if [ -z "$SG_ID" ] || [ "$SG_ID" == "None" ]; then
            echo "No security group named $SG_NAME found. Nothing to delete."
            exit 0
          fi
          echo "Found security group id: $SG_ID. Attempting to delete..."
          # Attempt to delete; may fail if still referenced
          if aws ec2 delete-security-group --group-id "$SG_ID"; then
            echo "Deleted security group $SG_ID"
          else
            echo "Failed to delete security group $SG_ID. It may still be referenced by resources."
            echo "You may need to detach or remove references before deletion."
            exit 1
          fi

      - name: Summary
        if: success()
        run: |
          echo "## 🗑️ Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Failure Summary
        if: failure()
        run: |
          echo "## ❌ Destroy Failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
